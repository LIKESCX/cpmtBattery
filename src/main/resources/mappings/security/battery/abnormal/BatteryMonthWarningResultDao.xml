<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cpit.cpmt.biz.dao.security.battery.abnormal.BatteryMonthWarningResultDao">
  <resultMap id="BaseResultMap" type="com.cpit.cpmt.dto.security.battery.abnormal.BatteryMonthWarningResult">
    <id column="id" jdbcType="VARCHAR" property="id" />
    <result column="operator_id" jdbcType="VARCHAR" property="operatorId" />
    <result column="station_id" jdbcType="VARCHAR" property="stationId" />
    <result column="equipment_id" jdbcType="VARCHAR" property="equipmentId" />
    <result column="connector_id" jdbcType="VARCHAR" property="connectorId" />
    <result column="area_code" jdbcType="VARCHAR" property="areaCode" />
    <result column="bms_code" jdbcType="VARCHAR" property="bmsCode" />
    <result column="bms_ver" jdbcType="VARCHAR" property="bmsVer" />
    <result column="warning_code" jdbcType="INTEGER" property="warningCode" />
    <result column="warning_desc" jdbcType="VARCHAR" property="warningDesc" />
    <result column="warning_code_times" jdbcType="INTEGER" property="warningCodeTimes" />
    <result column="warning_level_times" jdbcType="INTEGER" property="warningLevelTimes" />
    <result column="warning_level" jdbcType="INTEGER" property="warningLevel" />
    <result column="statistical_time" jdbcType="CHAR" property="statisticalTime" />
    <result column="in_time" jdbcType="TIMESTAMP" property="inTime" />
  </resultMap>
  <select id="queryBatteryMonthWarningResult" resultMap="BaseResultMap">
  	SELECT
			operator_id,
			station_id,
			equipment_id,
			connector_id,
			bms_code,
			area_code,
			warning_code,
			SUM(warning_code_times) AS warning_code_times,
			warning_level
		FROM
			`sec_battery_day_warning_result`
		WHERE
			operator_id = #{operatorId}
  		AND 
			statistical_time  between  DATE_FORMAT(#{startDate},'%Y-%m-%d') and DATE_FORMAT(#{endDate},'%Y-%m-%d')
		GROUP BY 
			operator_id,
			station_id,
			equipment_id,
			connector_id,
			area_code,
			bms_code,
			warning_code,
			warning_level
  </select>
  
  <!-- 批量插入 -->
  	<insert id="addBatchBatteryMonthWarningResult" parameterType="java.util.List">
  		INSERT INTO sec_battery_Month_warning_result
	    (
		    id,
		    operator_id,
			station_id,
			equipment_id,
			connector_id,
			bms_code,
			area_code,
			warning_code,
			warning_code_times,
			warning_level,
			statistical_time,
	  		in_time
  		)
		VALUES
  		<foreach collection="list" item="item" index="index" separator=",">
  			(   
  				#{item.id},
	  			#{item.operatorId},
	  			#{item.stationId},
	  			#{item.equipmentId},
	  			#{item.connectorId},
	  			#{item.bmsCode},
	  			#{item.areaCode},
	  			#{item.warningCode},
	  			#{item.warningCodeTimes},
	  			#{item.warningLevel},
	  			#{item.statisticalTime},
	  			#{item.inTime}
  			) 
  		</foreach>
  	</insert>
  	<select id="getEveryMonthBatteryWarningCodeDistribution" parameterType="com.cpit.cpmt.dto.security.battery.other.BatteryDataConditions" resultMap="BaseResultMap">
  	SELECT
		 warning_code,
		 SUM(warning_code_times) as warning_code_times
	FROM
	 `sec_battery_month_warning_result`
	WHERE
	  	statistical_time = #{statisticalTime}
	  	AND bms_code = #{bMSCode}
	  	<if test="allOperators==0"><!-- 表明运营商单选 -->
			AND operator_id = #{operatorId}
		</if>
		 <if test="allStations==0"><!-- 表明充电站单选 -->
			AND	station_id = #{stationId}	
		</if>
		<if test="allEquipments==0"><!-- 表明充电设备单选 -->
			AND equipment_id = #{equipmentId}
		</if>
	GROUP BY
	  warning_code
	<if test="allOperators==0">
	 ,operator_id
	</if>
	<if test="allStations==0">
 	 ,station_id
	</if>
	<if test="allEquipments==0">
	 ,equipment_id
	</if>
  	</select>
  	<select id="getEveryMonthBatteryWarningLevelDistribution" parameterType="com.cpit.cpmt.dto.security.battery.other.BatteryDataConditions" resultMap="BaseResultMap">
  	SELECT
		 warning_level,
		 SUM(warning_code_times) as warning_code_times
	FROM
	 `sec_battery_month_warning_result`
	WHERE
	  	statistical_time = #{statisticalTime}
	  	AND bms_code = #{bMSCode}
	  	<if test="allOperators==0"><!-- 表明运营商单选 -->
			AND operator_id = #{operatorId}
		</if>
		 <if test="allStations==0"><!-- 表明充电站单选 -->
			AND	station_id = #{stationId}	
		</if>
		<if test="allEquipments==0"><!-- 表明充电设备单选 -->
			AND equipment_id = #{equipmentId}
		</if>
	GROUP BY
	  warning_level
	<if test="allOperators==0">
	 ,operator_id
	</if>
	<if test="allStations==0">
	 ,station_id
	</if>
	<if test="allEquipments==0">
	 ,equipment_id
	</if>
  	</select>
  	<!-- 2.3.	异常告警数据挖掘分析 第四级钻取用  告警类型分布-->
  <select id="queryFourthLevelAlarmTypeDistribution" parameterType="com.cpit.cpmt.dto.security.battery.other.BatteryDataConditions" resultMap="BaseResultMap">
  	SELECT
			bms_code,
			warning_code,
			SUM(warning_code_times) AS warning_code_times
		FROM
			`sec_battery_month_warning_result`
		WHERE
			bms_code = #{param.bMSCode,jdbcType=VARCHAR}
		<if test="param.allOperators==0"><!-- 表明运营商单选 -->
			AND operator_id = #{param.operatorId}
		</if>
		 <if test="param.allStations==0"><!-- 表明充电站单选 -->
			AND	station_id = #{param.stationId}	
		</if>
		<if test="param.allEquipments==0"><!-- 表明充电设备单选 -->
			AND equipment_id = #{param.equipmentId}
		</if>
			AND statistical_time
			BETWEEN 
				DATE_FORMAT(
					#{param.startTime},
					'%Y%m%'
				)
			AND  
				DATE_FORMAT(
					#{param.endTime},
					'%Y%m'
				)
     		AND warning_code is not null and warning_code !=''
    		GROUP BY warning_code
  </select>
  <!-- 2.3.	异常告警数据挖掘分析 第四级钻取用  告警等级分布-->
  <select id="queryFourthLevelAlarmLevelDistribution"  parameterType="com.cpit.cpmt.dto.security.battery.other.BatteryDataConditions" resultMap="BaseResultMap">
  	SELECT
			bms_code,
			warning_level,
			SUM(warning_code_times) AS warning_level_times
		FROM
			`sec_battery_month_warning_result`
		WHERE
			bms_code = #{param.bMSCode,jdbcType=VARCHAR}
		<if test="param.allOperators==0"><!-- 表明运营商单选 -->
			AND operator_id = #{param.operatorId}
		</if>
		 <if test="param.allStations==0"><!-- 表明充电站单选 -->
			AND	station_id = #{param.stationId}	
		</if>
		<if test="param.allEquipments==0"><!-- 表明充电设备单选 -->
			AND equipment_id = #{param.equipmentId}
		</if>
			AND statistical_time
			BETWEEN 
				DATE_FORMAT(
					#{param.startTime},
					'%Y%m%'
				)
			AND  
				DATE_FORMAT(
					#{param.endTime},
					'%Y%m'
				)
     		AND warning_level is not null and warning_level !=''
    		GROUP BY warning_level
    </select>
</mapper>