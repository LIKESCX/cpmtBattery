<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cpit.cpmt.biz.dao.security.battery.normal.BatteryCollectDayChargeDao">
  <resultMap id="BaseResultMap" type="com.cpit.cpmt.dto.security.battery.normal.BatteryCollectDayCharge">
    <id column="id" jdbcType="VARCHAR" property="id" />
    <result column="operator_id" jdbcType="VARCHAR" property="operatorId" />
    <result column="station_id" jdbcType="VARCHAR" property="stationId" />
    <result column="equipment_id" jdbcType="VARCHAR" property="equipmentId" />
    <result column="connector_id" jdbcType="VARCHAR" property="connectorId" />
    <result column="bms_code" jdbcType="VARCHAR" property="bmsCode" />
    <result column="bms_ver" jdbcType="VARCHAR" property="bmsVer" />
    <result column="esti_r_last" jdbcType="INTEGER" property="estiRLast" />
    <result column="remain_capacity_sum" jdbcType="INTEGER" property="remainCapacitySum" />
    <result column="remain_capacity_last" jdbcType="INTEGER" property="remainCapacityLast" />
    <result column="charge_time_sum" jdbcType="INTEGER" property="chargeTimeSum" />
    <result column="charge_times_sum" jdbcType="INTEGER" property="chargeTimesSum" />
    <result column="charge_time_f" jdbcType="INTEGER" property="chargeTimeF" />
    <result column="charge_time_s" jdbcType="INTEGER" property="chargeTimeS" />
    <result column="sOH_sum" jdbcType="INTEGER" property="sohSum" />
    <result column="sOH_last" jdbcType="INTEGER" property="sohLast" />
    <result column="voltage_h" jdbcType="REAL" property="voltageH" />
    <result column="voltage_l" jdbcType="REAL" property="voltageL" />
    <result column="tatal_voltage_h" jdbcType="REAL" property="tatalVoltageH" />
    <result column="total_current_h" jdbcType="REAL" property="totalCurrentH" />
    <result column="tempture_h" jdbcType="INTEGER" property="temptureH" />
    <result column="tempture_l" jdbcType="INTEGER" property="temptureL" />
    <result column="before_soc_l" jdbcType="INTEGER" property="beforeSocL" />
    <result column="before_soc_sum" jdbcType="INTEGER" property="beforeSocSum" />
    <result column="after_soc_sum" jdbcType="INTEGER" property="afterSocSum" />
    <result column="after_soc_h" jdbcType="INTEGER" property="afterSocH" />
    <result column="end_time" jdbcType="TIMESTAMP" property="endTime" />
    <result column="statistical_time" jdbcType="DATE" property="statisticalTime" />
    <result column="statisticalTimes" jdbcType="TIMESTAMP" property="statisticalTimes" />
    <result column="in_time" jdbcType="TIMESTAMP" property="inTime" />
  </resultMap>
 <select id="queryBatteryCollectDay" resultMap="BaseResultMap">
  	select
	 a.operator_id,
	 a.station_id,
	 a.equipment_id,
	 a.connector_id,
	 a.bms_code,
	 b.sOH as sOH_last,
	 b.remain_capacity as remain_capacity_last,
	 b.esti_r as esti_r_last,
	 a.sOH_sum,
	 a.remain_capacity_sum,
	 a.charge_times_sum,
	 a.charge_time_sum,
	 a.charge_time_f,
	 a.charge_time_s,
	 a.tatal_voltage_h,
	 a.total_current_h,
	 a.voltage_h,
	 a.voltage_l,
	 a.tempture_h,
	 a.tempture_l,
	 a.before_soc_l,
	 a.before_soc_sum,
	 a.after_soc_h,
	 a.after_soc_sum,
	 a.end_time,
	 DATE_FORMAT(a.end_time,'%Y-%m-%d') as statistical_time
from 
(SELECT
	 operator_id,
	 station_id,
	 equipment_id,
	 connector_id,
	 bms_code,
	 IFNULL(SUM(sOH),0) as sOH_sum,
	 SUM(remain_capacity) as remain_capacity_sum,
	 COUNT(*) as charge_times_sum,
	 SUM(charge_time) as charge_time_sum,
	 MIN(charge_time) as charge_time_f,
	 MAX(charge_time) as charge_time_s,
	 MAX(tatal_voltage_h) as tatal_voltage_h,
	 MAX(total_current_h) as total_current_h,
	 MAX(voltage_h) as voltage_h,
	 MIN(voltage_l) as voltage_l,
	 MAX(tempture_h) as tempture_h,
	 MIN(tempture_l) as tempture_l,
	 MIN(before_soc) as before_soc_l,
	 SUM( before_soc) as before_soc_sum,
	 MAX(after_soc) as after_soc_h,
	 SUM( after_soc) as after_soc_sum,
	 MAX(end_time) as end_time
FROM
 `sec_battery_single_charge`
WHERE
	operator_id = #{operatorId,jdbcType=VARCHAR}
	AND
  	DATE_FORMAT(end_time,'%Y-%m-%d') = DATE_FORMAT(#{date},'%Y-%m-%d')
  	and code = 0
  	and bms_code is not null AND bms_code !='' AND bms_code!='-1' AND bms_code!='0' AND bms_code !='1'
GROUP BY
	 operator_id,
	 station_id,
	 equipment_id,
	 connector_id,
 	bms_code) as a , sec_battery_single_charge b 
 	where a.end_time = b.end_time and a.operator_id= b.operator_id and a.connector_id = b.connector_id
 
  </select>
  <insert id="addBatchBatteryCollectDay" parameterType="java.util.List">
  	INSERT INTO sec_battery_collect_day_charge
	 (
	 id,
	 operator_id,
	 station_id,
	 equipment_id,
	 connector_id,
	 bms_code,
	 sOH_last,
	 remain_capacity_last,
	 esti_r_last,
	 sOH_sum,
	 remain_capacity_sum,
	 charge_times_sum,
	 charge_time_sum,
	 charge_time_f,
	 charge_time_s,
	 tatal_voltage_h,
	 total_current_h,
	 voltage_h,
	 voltage_l,
	 tempture_h,
	 tempture_l,
	 before_soc_l,
	 before_soc_sum,
	 after_soc_h,
	 after_soc_sum,
	 end_time,
	 statistical_time,
	 in_time
  		)
	VALUES
 		<foreach collection="list" item="item" index="index" separator=",">
 			(   
 			#{item.id},
 			#{item.operatorId},
  			#{item.stationId},
  			#{item.equipmentId},
  			#{item.connectorId},
  			#{item.bmsCode},
  			#{item.sohLast},
  			#{item.remainCapacityLast},
  			#{item.estiRLast},
  			#{item.sohSum},
  			#{item.remainCapacitySum},
  			#{item.chargeTimesSum},
  			#{item.chargeTimeSum},
  			#{item.chargeTimeF},
  			#{item.chargeTimeS},
  			#{item.tatalVoltageH},
  			#{item.totalCurrentH},
  			#{item.voltageH},
  			#{item.voltageL},
  			#{item.temptureH},
  			#{item.temptureL},
  			#{item.beforeSocL},
  			#{item.beforeSocSum},
  			#{item.afterSocH},
  			#{item.afterSocSum},
  			#{item.endTime},
  			#{item.statisticalTime},
  			#{item.inTime}
 			) 
 		</foreach>
  	</insert>
  	<select id="getEveryDaySohAndRemainCapacity" parameterType="com.cpit.cpmt.dto.security.battery.other.BatteryDataConditions" resultMap="BaseResultMap">
  		SELECT
		 SUM(sOH_sum) as sOH_sum,
		 SUM(remain_capacity_sum) as remain_capacity_sum,
		 statistical_time
	FROM
	 `sec_battery_collect_day_charge`
	WHERE
	  	DATE_FORMAT(statistical_time,'%Y-%m') = DATE_FORMAT(#{time},'%Y-%m')
	  	AND bms_code = #{bMSCode}
	GROUP BY
	statistical_time
	<if test="allOperators==0">
	 ,operator_id
	</if>
	<if test="allStations==0">
	 ,station_id
	</if>
	<if test="allEquipments==0">
	 ,equipment_id
	</if>
  	</select>
  	
  <!-- 第一级钻取 按天粒度 -->
  <select id="queryFirstLevelData" resultMap="BaseResultMap" parameterType="com.cpit.cpmt.dto.security.battery.other.BatteryDataConditions">
  	SELECT
			bms_code,
			operator_id,
			station_id,
			equipment_id,
			connector_id,
			SUM(charge_times_sum) AS statisticalTimes,
			statistical_time
		FROM
			`sec_battery_collect_day_charge`
		<where>
			bms_code = #{param.bMSCode}
			AND	DATE_FORMAT(statistical_time, '%Y-%m-%d')
			BETWEEN DATE_FORMAT(
					#{param.startTime},
					'%Y-%m-%d'
				)
			AND  DATE_FORMAT(
				#{param.endTime},
				'%Y-%m-%d'
			)
			<if test="param.allOperators==0"><!-- 表明运营商单选 -->
				AND operator_id = #{param.operatorId}
			</if>
			 <if test="param.allStations==0"><!-- 表明充电站单选 -->
				AND	station_id = #{param.stationId}	
			</if>
			<if test="param.allEquipments==0"><!-- 表明充电设备单选 -->
				AND equipment_id = #{param.equipmentId}
			</if>
		</where>
		GROUP BY
			bms_code,
			operator_id,
			station_id,
			equipment_id,
			connector_id,
			DATE_FORMAT(statistical_time, '%Y-%m-%d')
		ORDER BY DATE_FORMAT(statistical_time, '%Y-%m-%d') ASC
    </select>
</mapper>