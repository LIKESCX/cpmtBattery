<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cpit.cpmt.biz.dao.exchange.bigscreen.ChargeDao">

    <select id="getChargeTimesByCondition"  resultType="java.util.Map">
        select
        date_format(a.charge_end_time, '%Y-%m-%d %H:%i') as in_time ,
        count(id) as times
        from exc_connector_charge_info a
        where
        a.charge_end_time is not null
        group by in_time
        having
        <![CDATA[ in_time >= #{startTime} ]]>
        and
        <![CDATA[ in_time <= #{endTime} ]]>
    </select>


    <select id="getChargeStatusByCondition" resultType="java.util.Map">
        SELECT a.in_time as date,ifnull(b.free,0) free,ifnull(c.WORK,0)work from  (
        sELECT DATE_FORMAT( @cdate := DATE_ADD( @cdate, INTERVAL 1 MINUTE ), '%Y-%m-%d %H:%i' ) AS in_time
        FROM (SELECT @cdate := DATE_ADD( #{startTime}, INTERVAL -1 MINUTE ) FROM  exc_operator_info  limit #{time}) t0
        WHERE DATE( @cdate )  <![CDATA[ <= #{endTime} ]]>)a
        LEFT JOIN (SELECT date_format(`in_time`, '%Y-%m-%d %H:%i') as in_time,count(1) free FROM exc_connector_status_info WHERE  <![CDATA[ in_time >= #{startTime} ]]> and  <![CDATA[ in_time <= #{endTime} ]]> and status in (0,1)
        group by date_format(`in_time`, '%Y-%m-%d %H:%i'))b on a.in_time = b.in_time
        LEFT JOIN (SELECT date_format(`in_time`, '%Y-%m-%d %H:%i') as in_time,count(1) WORK FROM exc_connector_status_info WHERE <![CDATA[ in_time >= #{startTime} ]]> and  <![CDATA[ in_time <= #{endTime} ]]> and status NOT in (0,1)
        group by date_format(`in_time`, '%Y-%m-%d %H:%i'))c  on a.in_time = c.in_time
    </select>

</mapper>